import os

rule align_bwa_mem2:
    input:
        r1 = os.path.join(config["batch_out"], "fastp_outs", "trimmed_fqs", "{sample}.trimmed_1.fastq.gz"),
        r2 = os.path.join(config["batch_out"], "fastp_outs", "trimmed_fqs", "{sample}.trimmed_2.fastq.gz")
    output:
        sorted_bam = os.path.join(config["batch_out"], "fq2bam_outs", "{sample}", "{sample}.sorted.bam")
    log:
        os.path.join(config["batch_out"], "fq2bam_outs", "{sample}", "logs", "align.log")
    params:
        sif_bwa = config["containers"]["bwamem2"],
        sif_sam = config["containers"]["samtools"],
        idx_prefix = config["references"]["bwamem2_idx"],
        rg = r"@RG\tID:{sample}\tLB:{sample}\tPL:ILLUMINA\tSM:{sample}\tPU:{sample}"
    threads:
        config["resources"]["align"]["cpus"]
    resources:
        mem_mb = config["resources"]["align"]["mem_mb"],
        runtime = config["resources"]["align"]["runtime"],
        cpus = config["resources"]["align"]["cpus"]
    shell:
        """
        set -euo pipefail
        module --force purge
        module load apptainer

        mkdir -p "$(dirname {output.sorted_bam})"
        mkdir -p "$(dirname {log})"

        # Write debug info
        echo "=== align_bwa_mem2 (actually bwa mem) on $(hostname) at $(date) ===" > {log}
        echo "R1: {input.r1}" >> {log}
        echo "R2: {input.r2}" >> {log}
        echo "Reference prefix: {params.idx_prefix}" >> {log}
        echo "BWA SIF: {params.sif_bwa}" >> {log}
        echo "SAMTOOLS SIF: {params.sif_sam}" >> {log}
        echo "Threads requested: {threads}" >> {log}
        echo "Read group: {params.rg}" >> {log}
        echo >> {log}
        echo "Checking FASTQs and reference index..." >> {log}
        ls -lh {input.r1} {input.r2} >> {log} 2>&1 || echo "WARNING: FASTQs not found!" >> {log}
        ls -lh {params.idx_prefix}* >> {log} 2>&1 || echo "WARNING: reference index files may be missing!" >> {log}
        echo >> {log}
        echo "Running: bwa mem | samtools sort" >> {log}

        # BWA-MEM command (classic bwa, not bwa-mem2)
        CMD_BWA="apptainer exec --bind /global/project,/global/scratch {params.sif_bwa} \
          bwa mem \
            -t {threads} \
            -Y \
            -R '{params.rg}' \
            {params.idx_prefix} \
            {input.r1} {input.r2}"

        # Samtools sort command
        CMD_SORT="apptainer exec --bind /global/project,/global/scratch {params.sif_sam} \
          samtools sort \
            -@ {threads} \
            -o {output.sorted_bam} \
            -"

        # Execute with logging
        eval "$CMD_BWA" 2>> {log} | eval "$CMD_SORT" 2>> {log}

        if [[ ! -s {output.sorted_bam} ]]; then
            echo "ERROR: sorted BAM is missing or empty" >> {log}
            exit 1
        fi

        echo "Alignment + sort completed successfully at $(date)" >> {log}
        """

